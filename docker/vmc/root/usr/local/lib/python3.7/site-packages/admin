"""
 * Licensed to DSecure.me under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. DSecure.me licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
"""
#!/venv/bin/python3
# -*- coding: utf-8 -*-

import sys
import os

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "vmc.config.settings")

from django.core.wsgi import get_wsgi_application
application = get_wsgi_application()

from django.core import management
from vmc.common.management.commands import wait_for_amqp, wait_for_db, wait_for_es
from vmc.elasticsearch.management.commands import create_index

from gunicorn.app.wsgiapp import run


if __name__ == '__main__':
    management.call_command(wait_for_amqp.Command())
    management.call_command(wait_for_db.Command())
    management.call_command(wait_for_es.Command())

    management.call_command('migrate')
    management.call_command(create_index.Command())

    sys.argv = ["admin", "--bind=0.0.0.0:8001", "--access-logfile='-'", "vmc.config.wsgi:application"]
    sys.exit(run())